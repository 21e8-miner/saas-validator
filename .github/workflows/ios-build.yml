name: â˜ï¸ Cloud Build & Ship to App Store

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-ship:
    runs-on: macos-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ðŸ“¦ Install Dependencies
        run: |
          npm ci
          npm install @capacitor/core @capacitor/cli @capacitor/ios

      - name: ðŸ—ï¸ Build Web App
        run: |
          mkdir -p www
          cp index.html style.css script.js auth.html auth.js pricing.html pricing.js www/
          cp -r assets www/ || true
          npx cap add ios
          npx cap sync ios

      - name: ðŸ’Ž Install Fastlane
        run: sudo gem install fastlane

      - name: ðŸŽ Sign & Deploy to App Store
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}
        run: |
          if [ -z "$APP_STORE_CONNECT_API_KEY_ID" ]; then
            echo "âš ï¸ No Signing Keys found in GitHub Secrets."
            echo "â„¹ï¸ Skipping upload. This will be an unsiged dry-run build."
            # Fallback to unsigned build for verification
            cd ios/App
            xcodebuild archive -workspace App.xcworkspace -scheme App -destination "generic/platform=iOS" -archivePath App.xcarchive CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
          else
            echo "âœ… Signing Keys found! Building and Uploading to App Store..."
            # Create a temporary Fastfile for cloud execution
            cd ios/App
            cat > Fastfile <<EOF
            default_platform(:ios)
            platform :ios do
              desc "Cloud Build & Upload"
              lane :release do
                build_app(workspace: "App.xcworkspace", scheme: "App")
                upload_to_app_store(force: true, skip_waiting_for_build_processing: true)
              end
            end
            EOF
            fastlane ios release
          fi

      - name: ðŸ“¤ Upload Artifact (Unsigned only)
        if: ${{ env.APP_STORE_CONNECT_API_KEY_ID == '' }}
        uses: actions/upload-artifact@v3
        with:
          name: saas-validator-ios-unsigned
          path: ios/App/App.xcarchive
